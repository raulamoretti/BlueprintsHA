blueprint:
  name: Proteção Industrial de Tomada v2
  description: Proteção contra tensão fora da faixa com religamento seguro.
  domain: automation

  input:
    plug:
      name: Tomada
      selector:
        entity:
          domain: switch

    voltage_sensor:
      name: Sensor de Tensão
      selector:
        entity:
          domain: sensor

    surge_counter:
      name: Contador de Surtos
      selector:
        entity:
          domain: counter

    notify_device:
      name: Dispositivo para notificação
      selector:
        device:
          integration: mobile_app

    nominal_voltage:
      name: Tensão da rede
      default: "127"
      selector:
        select:
          options:
            - label: "127 V"
              value: "127"
            - label: "220 V"
              value: "220"

    cut_delta:
      name: Desvio para desligar (±V)
      default: 12
      selector:
        number:
          min: 5
          max: 40
          unit_of_measurement: V

    restore_delta:
      name: Faixa segura para religar (±V)
      default: 8
      selector:
        number:
          min: 3
          max: 25
          unit_of_measurement: V

    stabilize_time:
      name: Tempo mínimo de tensão estável (min)
      default: 3
      selector:
        number:
          min: 1
          max: 30
          unit_of_measurement: min

    compressor_delay:
      name: Tempo mínimo desde o último desligamento (min)
      default: 10
      selector:
        number:
          min: 0
          max: 30
          unit_of_measurement: min

    long_off_alert:
      name: Alerta se desligada por (min)
      default: 20
      selector:
        number:
          min: 5
          max: 120
          unit_of_measurement: min

mode: restart

variables:
  plug_entity: !input plug
  voltage_entity: !input voltage_sensor
  counter_entity: !input surge_counter
  nominal_v: !input nominal_voltage
  cut_d: !input cut_delta
  restore_d: !input restore_delta

trigger:
  - platform: state
    entity_id: !input voltage_sensor

  - platform: state
    entity_id: !input plug
    to: "off"
    for:
      minutes: !input long_off_alert

action:
  - variables:
      v: "{{ states(voltage_entity) | float(0) }}"
      n: "{{ nominal_v | float }}"
      cut: "{{ cut_d | float }}"
      res: "{{ restore_d | float }}"
      last_off: "{{ states[plug_entity].last_changed }}"
      minutes_since_off: "{{ (as_timestamp(now()) - as_timestamp(last_off)) / 60 }}"

  - choose:

      - conditions:
          - condition: template
            value_template: "{{ v < (n - cut) or v > (n + cut) }}"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: "{{ plug_entity }}"

          - service: counter.increment
            target:
              entity_id: "{{ counter_entity }}"

          - service: logbook.log
            data:
              name: Proteção de Tensão
              message: "Desligada por tensão fora do limite ({{ v }}V)"
              entity_id: "{{ plug_entity }}"

          - service: notify.notify
            data:
              title: "Proteção de Tensão"
              message: "Tomada desligada. Tensão atual: {{ v }}V"

      - conditions:
          - condition: template
            value_template: "{{ (n - res) <= v <= (n + res) and minutes_since_off >= (!input compressor_delay) }}"
        sequence:
          - delay:
              minutes: !input stabilize_time

          - service: switch.turn_on
            target:
              entity_id: "{{ plug_entity }}"

          - service: logbook.log
            data:
              name: Proteção de Tensão
              message: "Tomada religada após condições seguras"
              entity_id: "{{ plug_entity }}"

      - conditions:
          - condition: template
            value_template: "{{ trigger.platform == 'state' }}"
        sequence:
          - service: notify.notify
            data:
              title: "Alerta de Energia"
              message: "A geladeira está desligada há muito tempo."
