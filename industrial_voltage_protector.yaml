blueprint:
  name: Proteção de Tensão Tomada (Fail-Safe v4.1)
  description: Proteção contra subtensão e sobretensão com lógica defensiva.
  domain: automation

  input:
    plug:
      name: Tomada
      selector:
        entity:
          domain: switch

    voltage_sensor:
      name: Sensor de Tensão
      selector:
        entity:
          domain: sensor

    surge_counter:
      name: Contador de Surtos
      selector:
        entity:
          domain: counter

    notify_device:
      name: Dispositivo para notificação
      selector:
        device:
          integration: mobile_app

    cut_below:
      name: Limite inferior de corte (V)
      default: 115
      selector:
        number:
          min: 80
          max: 200
          unit_of_measurement: V

    cut_above:
      name: Limite superior de corte (V)
      default: 140
      selector:
        number:
          min: 120
          max: 260
          unit_of_measurement: V

    restore_below:
      name: Limite inferior para religar (V)
      default: 119
      selector:
        number:
          min: 90
          max: 200
          unit_of_measurement: V

    restore_above:
      name: Limite superior para religar (V)
      default: 135
      selector:
        number:
          min: 110
          max: 260
          unit_of_measurement: V

    stabilize_time:
      name: Tempo de tensão estável (min)
      default: 3
      selector:
        number:
          min: 1
          max: 30

    compressor_delay:
      name: Tempo mínimo compressor desligado (min)
      default: 10
      selector:
        number:
          min: 0
          max: 30

mode: single

variables:
  plug_entity: !input plug
  voltage_entity: !input voltage_sensor
  cut_low: !input cut_below
  cut_high: !input cut_above
  restore_low: !input restore_below
  restore_high: !input restore_above

trigger:
  - platform: numeric_state
    entity_id: !input voltage_sensor
    below: !input cut_below

  - platform: numeric_state
    entity_id: !input voltage_sensor
    above: !input cut_above

  - platform: numeric_state
    entity_id: !input voltage_sensor
    above: !input restore_below
    below: !input restore_above
    for:
      minutes: !input stabilize_time

action:
  - variables:
      v: "{{ states(voltage_entity) | float(0) }}"
      cut_l: "{{ cut_low | float }}"
      cut_h: "{{ cut_high | float }}"
      res_l: "{{ restore_low | float }}"
      res_h: "{{ restore_high | float }}"

  - choose:

      # DESLIGA APENAS SE TENSÃO REALMENTE FORA
      - conditions:
          - condition: template
            value_template: "{{ v < cut_l or v > cut_h }}"
          - condition: state
            entity_id: !input plug
            state: "on"
        sequence:
          - service: switch.turn_off
            target:
              entity_id: !input plug

          - service: counter.increment
            target:
              entity_id: !input surge_counter

          - service: notify.notify
            data:
              title: "Proteção de Tensão"
              message: "Tomada desligada por tensão fora do limite."

      # RELIGA APENAS SE TENSÃO SEGURA
      - conditions:
          - condition: template
            value_template: "{{ res_l <= v <= res_h }}"
          - condition: state
            entity_id: !input plug
            state: "off"
        sequence:
          - delay:
              minutes: !input compressor_delay

          - service: switch.turn_on
            target:
              entity_id: !input plug

          - service: notify.notify
            data:
              title: "Energia Restabelecida"
              message: "Tomada religada com segurança."
